==================================================

Document Title:
Intent State Machine for Wearable-Based Drone Control
웨어러블 기반 드론 제어를 위한 의도 상태 머신

Version:
v0.1 (Draft – Logic Freeze Target)
버전 v0.1 (초안 – 로직 고정 단계)

Author: Do yuhan
작성자: 도유한

Date: 2026-02-05
작성일 2026-02-05

==================================================
Design Philosophy
설계 철학
==================================================

The system prioritizes human cognitive stability over raw control aggressiveness.
본 시스템은 제어의 공격성보다 인간의 인지적 안정성을 우선한다.

User intent is treated as a continuous confidence signal,
not a binary on/off command.
사용자 의도는 이진적인 명령이 아닌
연속적인 신뢰도 신호로 취급된다.

Control authority is gradually shifted between user intent
and system stabilization based on Demand Level.
제어 권한은 의도 신뢰도에 따라
사용자와 시스템 안정화 로직 사이에서 점진적으로 전이된다.

==================================================
0. High-Level Intent State and Safety Gating
상위 의도 상태 및 안전 게이팅 정의
==================================================

This document distinguishes between:
(1) High-level engagement permission (state)
(2) Continuous authority-shaping signal (P_value)

본 문서는 다음 두 개념을 구분한다.
(1) 상위 조종 허가 상태(state)
(2) 연속적인 권한 성형 신호(P_value)

High-level intent state defines whether the system is allowed
to forward human-generated setpoints to PX4 Offboard control.
상위 의도 상태는 인간 입력으로부터 생성된 setpoint를
PX4 Offboard 제어로 전달할 수 있는지(조종 허가)를 정의한다.

Define the high-level intent state as:
상위 의도 상태는 다음과 같이 정의한다.

STATE: DISENGAGED
-No user control authority is granted.
-In DISENGAGED, roll/pitch/yaw rate setpoints and Vz_out are forced to 0 using failsafe slew/jerk limits.

상태: DISENGAGED (비허가)
-사용자 제어 권한이 허가되지 않는다.
-DISENGAGED 상태에서는 roll/pitch/yaw rate setpoint 및 Vz_out을 failsafe 변화율/저크 제한 하에서 0으로 강제한다.

STATE: ENGAGED
-User control authority is granted under safety constraints.
-Offboard setpoints are forwarded after first-layer bounding.

상태: ENGAGED (허가)
-안전 제한 하에 사용자 제어 권한이 허가된다.
-Offboard setpoint는 1차 제한 이후 전달된다.

Safety gating acts as a hard override above P_value-based blending.
안전 게이팅은 P_value 기반 혼합 로직보다 상위에서 동작하는
하드 오버라이드(hard override)이다.

If safety gating is violated, the system must transition to DISENGAGED
or force a safe neutral output immediately.
안전 게이팅 조건이 위반되면 시스템은 DISENGAGED로 전이하거나
즉시 안전 중립 출력으로 강제되어야 한다.

Safety gating conditions include (examples / minimum set):
-Offboard link health (heartbeat timeout / command stream loss)
-Estimator health / attitude validity (EKF health flags)
-Vehicle arming state and flight mode validity
-Sensor data freshness / timestamp validity
-Human input validity (out-of-range, NaN, spike detection)
-User-defined emergency gesture / kill gesture

안전 게이팅 조건은 다음을 포함한다 (예시 / 최소 조건 집합).
-오프보드 링크 상태(하트비트 타임아웃 / 명령 스트림 손실)
-추정기 상태 및 자세 유효성(EKF 헬스 플래그)
-기체 arming 상태 및 비행 모드 유효성
-센서 데이터 신선도/타임스탬프 유효성
-인간 입력 유효성(범위 이탈, NaN, 스파이크)
-사용자 정의 비상 제스처/킬 제스처

P_value is a continuous authority-shaping signal derived from tracking error.
And P_value is used only within ENGAGED to modulate how aggressively user-generated setpoints are forwarded and how stabilization-driven braking is blended.
P_value는 tracking error로부터 계산되는 연속적인 권한 성형(authority-shaping) 신호이다.
이는 ENGAGED 상태 내부에서만 사용자 setpoint 전달 강도 및 안정화 기반 제동(blending)을 조절하는 데 사용된다.

P_value is not a pure Demand Level measure; 
it may increase due to external disturbances or vehicle response lag. 
The design assumes PX4 handles most disturbance rejection, 
and P_value is treated as a practical proxy for “effective control demand” at the intent layer.
P_value는 **순수한 의도 신뢰도(Demand Level)**가 아니다.
외란 또는 기체 응답 지연으로도 증가할 수 있다. 
본 설계는 외란 억제를 PX4가 최대한 담당한다는 가정 하에, 
P_value를 의도 해석 레이어에서의 “유효 제어 요구(effective control demand)” 프록시로 사용한다.

==================================================
0-X. Global Override Priority (Hard Order)
전역 오버라이드 우선순위(고정 순서)
==================================================

The system applies the following priority order to resolve simultaneous conditions.
본 시스템은 동시에 여러 조건이 발생했을 때 아래 우선순위 순서로 충돌을 해소한다.

(1) Manual engage button (permission gate)
(1) 수동 인게이지 버튼(허가 게이트)

If the engage button is not pressed (or is released), the system is DISENGAGED and forces safe-stop behavior.
버튼이 눌려 있지 않거나(또는 해제되면) 시스템은 DISENGAGED이며 safe-stop 동작을 강제한다.

(2) Safety gating violation (system safety override)
(2) 안전 게이팅 위반(시스템 안전 오버라이드)

Any safety gating violation forces DISENGAGED immediately (regardless of P_value, ENTRY, or any sub-logic).
안전 게이팅 위반이 발생하면 P_value/ENTRY/하위 로직과 무관하게 즉시 DISENGAGED를 강제한다.

(3) DISENGAGED enforcement behavior
(3) DISENGAGED 강제 동작

In DISENGAGED, all user-generated setpoints are driven to zero by the defined failsafe/ramp-down logic.
DISENGAGED에서는 사용자 setpoint를 정의된 failsafe/ramp-down 로직으로 0에 수렴시킨다.

(4) ENGAGED sub-phase shaping (ENTRY dwell logic)
(4) ENGAGED 하위 구간 성형(ENTRY dwell 로직)

If ENGAGED and in ENTRY dwell, apply ENTRY authority shaping and Hardgate-triggered ENTRY reset/cap rules.
ENGAGED이며 ENTRY dwell 중이면, ENTRY 권한 성형과 Hardgate 기반 ENTRY reset/cap 규칙을 적용한다.

(5) ENGAGED steady forwarding + sensitive operations gating
(5) ENGAGED 정상 전달 + 민감 동작 게이팅

Outside ENTRY, forward user setpoints with minimal shaping;
apply gating only to non-output state updates (e.g., neutral commit) and to abnormal persistence escalation 
(e.g., Hardgate persist → DISENGAGED).
ENTRY 밖에서는 최소 성형으로 setpoint를 전달한다. 
단, 출력이 아닌 상태 갱신성 동작(예: neutral commit)과 비정상 지속 승격
(Hardgate persist → DISENGAGED)에만 게이팅을 적용한다.

==================================================
1. Roll/Pitch Demand-Shaped Control (Common Attitude Axes)
Roll/Pitch 요구(demand) 기반 권한 성형 제어 (공통 자세 축)
==================================================

This section defines demand interpretation and control shaping
for roll and pitch axes, which are treated as a coupled attitude plane.
본 섹션은 roll/pitch 축에 대한 요구 해석 및 제어 신호 성형을 정의한다.
roll/pitch는 동역학적으로 결합된 자세 평면으로 취급된다.

The goal is cognitively stable rate control by shaping control authority as a continuous function of observed tracking error.
This is achieved via demand-weighted blending between user-generated commands and stabilization-driven braking.
본 목표는 tracking error로부터 관측되는 “유효 제어 요구(effective control demand)”에 따라 제어 권한을 연속적으로 성형하여 인지적으로 안정적인 rate 제어를 달성하는 것이다.
이를 위해 사용자 생성 명령과 안정화 기반 제동을 demand 가중 혼합(demand-weighted blending)으로 결합한다.

--------------------------------------------------
1-1. Signal Definitions (Roll/Pitch)
신호 정의 (Roll/Pitch)
--------------------------------------------------

intent_rate:
Desired rotational rate inferred from user gesture.
사용자 제스처로부터 추정된 목표 회전 속도.

actual_rate:
Measured rotational rate of the drone.
드론의 실제 측정 회전 속도.

rate_error:
Difference between intent_rate and actual_rate.
의도된 속도와 실제 속도의 차이.

P_value:
Continuous authority-shaping signal derived from rate_error magnitude (effective control demand proxy).
rate_error 크기로부터 계산되는 연속 권한 성형 신호(유효 제어 요구 프록시).

brake_weight:
Weight applied to stabilization-driven braking term (inverse to authority gain).
안정화 기반 제동 항에 적용되는 가중치(권한 게인과 반비례).

--------------------------------------------------
1-2. Rate Error and P_value (Authority-Shaping) Definition
rate 오차 및 P_value(권한 성형) 정의
--------------------------------------------------

Rate error is defined as the difference between intent rate and measured rate.
rate 오차는 의도 rate와 실제 측정 rate의 차이로 정의한다.

For roll and pitch axes, define:
roll/pitch 축에 대해 다음을 정의한다:

e_rate_roll = intent_rate_roll - actual_rate_roll
e_rate_pitch = intent_rate_pitch - actual_rate_pitch

A scalar magnitude is used for gating decisions:
게이팅 판단에는 스칼라 크기 값을 사용한다:

e_mag = norm([e_rate_roll, e_rate_pitch])
e_mag = norm([e_rate_roll, e_rate_pitch])

P_value is proportional to the rate error magnitude with saturation:
P_value는 rate 오차 크기에 비례하며 포화(saturation)를 둔다:

P_value = clamp(Kp_intent * e_mag, 0, 1)
P_value = clamp(Kp_intent * e_mag, 0, 1)

Kp_intent is an authority-shaping scaling gain (NOT PX4 internal PID gain).
Kp_intent는 권한 성형(authority-shaping) 스케일링 게인이며(PX4 내부 PID 게인과 무관), 의도 해석 레이어의 파라미터이다.

(It maps observed tracking error magnitude to a bounded demand/authority level P_value.)
(관측된 tracking error 크기를 [0,1]로 제한된 demand/authority 레벨 P_value로 매핑한다.)

--------------------------------------------------
1-3. Demand Zones for Authority Shaping (Roll/Pitch)
권한 성형을 위한 요구(demand) 구간 정의 (Roll/Pitch)
--------------------------------------------------

P_value is defined as a tracking-error-based authority-shaping signal and is used to modulate blending between user-generated commands and stabilization-driven braking within ENGAGED.
Because disturbances or response lag can increase rate error, P_value is not interpreted as pure human Demand Level. Instead, it represents the magnitude of “effective control demand” observed at the intent layer.

P_value는 tracking error 기반 권한 성형 신호로 정의되며, ENGAGED 상태에서 사용자 명령과 안정화 기반 제동의 혼합 비율을 조절하는 데 사용된다.
외란/응답 지연으로도 rate error가 증가할 수 있으므로, P_value를 순수 의도 신뢰도로 해석하지 않는다. 대신 의도 해석 레이어에서 관측되는 “유효 제어 요구(effective control demand)”의 크기로 해석한다.

Zone 1: Low Demand (P_value ≤ P_low)
구간 1: 낮은 요구 구간 (P_value ≤ P_low)

Zone 2: Transitional Demand (P_low < P_value < P_high)
구간 2: 전이 요구 (P_low < P_value < P_high)

Zone 3: Strong Demand (P_value ≥ P_high)
구간 3: 강한 요구 구간 (P_value ≥ P_high)

--------------------------------------------------
1-4. Gain Mapping Strategy
게인 매핑 전략
--------------------------------------------------

A minimum gain value 'a' is maintained to avoid deadzone behavior.
deadzone 동작을 방지하기 위해 최소 게인 값 a를 유지한다.

In the transitional zone, gain is increased smoothly using a smoothstep function.
전이 구간에서는 smoothstep 함수를 사용하여
게인을 부드럽게 증가시킨다.

In the high-demand zone, authority gain is fixed at 1.0 and braking logic is disabled.
높은 요구 구간에서는 권한 게인을 1.0으로 고정하고 제동 로직을 비활성화한다.

--------------------------------------------------
1-4-1. Smoothstep Gain Formulation
스무스스텝 기반 게인 수식 정의
--------------------------------------------------

The authority gain g(P_value) is computed as a continuous function of P_value.
권한 게인 g(P_value)는 P_value의 연속 함수로 계산된다.

Define two demand thresholds:
두 개의 요구 임계값을 정의한다:

P_low : lower boundary of transitional demand
P_high : upper boundary of transitional demand

P_low : 전이 구간의 하한
P_high : 전이 구간의 상한

Normalize demand level within the transitional zone:
전이 구간에서 요구 레벨을 정규화한다:

x = clamp((P_value - P_low) / (P_high - P_low), 0, 1)
x = clamp((P_value - P_low) / (P_high - P_low), 0, 1)

Apply smoothstep to obtain a continuous transition:
연속적인 전이를 위해 smoothstep 함수를 적용한다:

s(x) = 3x^2 - 2x^3
s(x) = 3x^2 - 2x^3

The final demand gain is defined as:
최종 요구 게인은 다음과 같이 정의된다:

g(P_value) = a + (1 - a) * s(x)
g(P_value) = a + (1 - a) * s(x)

For P_value ≥ P_high, the gain is saturated:
P_value ≥ P_high 인 경우 게인은 포화된다:

g(P_value) = 1.0
g(P_value) = 1.0

--------------------------------------------------
1-5. First-Layer Bounding of Intent Rate Demand
요구 rate 명령의 1차 제한 (해석 레이어)
--------------------------------------------------

Demand rate commands are bounded at the Demand interpretation layer
before being sent to PX4.
요구 rate 명령은 PX4로 전달되기 전에
요구 해석 레이어에서 1차적으로 제한된다.

This first-layer bounding includes:
이 1차 제한에는 다음이 포함된다:
-Magnitude saturation of rate commands
-Rate-of-change (slew-rate) limiting
-Demand-level-based authority shaping
-rate 명령의 크기 포화(saturation)
-rate 변화율 제한(slew-rate limit)
-요구(demand) 기반 권한 성형

The purpose of this layer is to transform noisy,
ambiguous human input into control signals suitable for aircraft-level controllers.
이 레이어의 목적은 노이즈가 많고 모호한 인간 입력을
항공기 제어기에 적합한 제어 신호로 변환하는 것이다.

This layer does not replace PX4 safety mechanisms,
but complements them by preventing unrealistic
or cognitively unsafe setpoints from being generated.
이 레이어는 PX4의 안전 메커니즘을 대체하지 않으며,
비현실적이거나 인지적으로 위험한 setpoint가
생성되는 것을 사전에 방지함으로써 이를 보완한다.

--------------------------------------------------
1-6. Braking Logic (Demand-Weighted Braking)
제동 로직 (요구(demand) 기반 제동)
--------------------------------------------------

Braking strength is inversely proportional to authority gain.
제동 강도는 권한 게인에 반비례한다.

Braking is applied preemptively when observed demand decreases, rather than waiting for demand to reach zero.
제동은 요구 레벨이 감소하는 시점에서 선제적으로 적용되며, demand가 완전히 0이 된 이후를 기다리지 않는다.

A dwell-time-based weighting is applied in the low intent zone
to ensure stable and complete stopping.
낮은 의도 구간에서는 체류 시간 기반 가중치를 적용하여
안정적이고 완전한 정지를 보장한다.

--------------------------------------------------
1-6-1. Rate Setpoint Composition (Active + Braking Blend)
rate setpoint 구성 방식 (능동 + 제동 혼합)
--------------------------------------------------

The final body-rate setpoint is composed as a weighted sum
of active control and braking control.
최종 body-rate setpoint는 능동 제어와 제동 제어의 가중 합으로 구성된다.

Define the active rate command:
능동 rate 명령을 정의한다:

rate_active = intent_rate
rate_active = intent_rate

Define the braking (linear floor) rate:
제동(리니어 플로어) rate를 정의한다:

rate_brake = -K_floor * actual_rate
rate_brake = -K_floor * actual_rate

The final rate setpoint is computed as:
최종 rate setpoint는 다음과 같이 계산된다:

rate_setpoint = g(P_value) * rate_active
+ (1 - g(P_value)) * rate_brake

rate_setpoint = g(P_value) * rate_active
+ (1 - g(P_value)) * rate_brake

This formulation ensures smooth transition between
intent-driven control and stabilization-driven braking.
이 구성은 의도 기반 제어와 안정화 기반 제동 사이의
부드러운 전이를 보장한다.

--------------------------------------------------
1-6-2. Dwell-Time-Based Braking Reinforcement
체류 시간 기반 제동 강화
--------------------------------------------------

In the low intent zone (P_value ≤ P_low),
braking strength is reinforced over time.
낮은 의도 구간(P_value ≤ P_low)에서는
시간에 따라 제동 강도가 강화된다.

Define dwell time t_dwell as the duration spent in the low intent zone.
체류 시간 t_dwell을 낮은 의도 구간에 머문 시간으로 정의한다.

A dwell-time weighting function is applied:
체류 시간 가중치 함수를 적용한다:

w_dwell(t) = clamp(t_dwell / T_stop, 0, 1)
w_dwell(t) = clamp(t_dwell / T_stop, 0, 1)

The effective braking gain is updated as:
유효 제동 게인은 다음과 같이 갱신된다:

K_floor_eff = K_floor * (1 + w_dwell(t))
K_floor_eff = K_floor * (1 + w_dwell(t))

This mechanism ensures stable and complete stopping
without abrupt control cutoff.
이 메커니즘은 급격한 제어 차단 없이
안정적이고 완전한 정지를 보장한다.

--------------------------------------------------
1-7. State Transition Overview (Roll/Pitch)
상태 전이 개요 (Roll/Pitch)
--------------------------------------------------

High Demand → Transitional Demand:
Gradual reduction of control aggressiveness.
강한 요구 → 전이 구간:
제어 공격성을 점진적으로 감소.

Transitional Demand → Low Demand:
Activation of braking dominance.
전이 구간 → 낮은 요구 구간:
제동 로직의 주도권 활성화.

Low Demand → Stabilized State:
Terminal stabilization using braking and decay.
낮은 요구 → 안정 상태:
제동 및 감쇠를 통한 최종 안정화.

--------------------------------------------------
1-8. Safety and Human Factors (Roll/Pitch)
안전 및 인간 요인 고려 (Roll/Pitch)
--------------------------------------------------

The system avoids abrupt control discontinuities
to prevent cognitive discomfort.
본 시스템은 인지적 불편을 방지하기 위해
급격한 제어 불연속을 피한다.

Control authority is never taken away from the user unexpectedly.
제어 권한은 사용자의 인지 없이
갑작스럽게 시스템으로 넘어가지 않는다.

--------------------------------------------------
1-9. Open Parameters for Experimental Tuning (Roll/Pitch)
실험 기반 튜닝 대상 파라미터 (Roll/Pitch)
--------------------------------------------------

The following parameters are tuned experimentally to balance
responsiveness, stability, and perceived control authority
under human-in-the-loop operation.
다음 파라미터들은 인간 개입 제어 환경에서
반응성, 안정성, 체감 제어 권한의 균형을 맞추기 위해
실험적으로 튜닝된다.

Minimum authority gain value (a)
: minimum control authority to avoid perceptual deadzone

Smoothstep transition boundaries (P_low, P_high)
: demand thresholds defining zone transitions

Dwell time duration in low intent zone (T_stop)
: time constant for braking reinforcement under low intent

Braking floor gain (K_floor)
: strength of stabilization-driven braking relative to actual rate

Authority-shaping scaling gain (Kp_intent)
: maps rate error magnitude to bounded demand level P_value


최소 의도 게인 값 (a)
: 체감 deadzone을 방지하기 위한 최소 제어 권한

smoothstep 전이 경계값 (P_low, P_high)
: 요구(demand) 구간 전이를 정의하는 임계값

낮은 의도 구간 체류 시간 (T_stop)
: 낮은 의도 상태에서 제동 강화가 누적되는 시간 상수

제동 플로어 게인 (K_floor)
: 실제 rate 대비 안정화 기반 제동 강도

권한 성형 스케일링 게인(Kp_intent)
: rate error 크기를 [0,1]의 demand 레벨 P_value로 매핑

Note:
These parameters do not alter system structure or safety logic,
but adjust the quantitative trade-off between responsiveness
and stabilization under identical control architecture.

비고:
이 파라미터들은 시스템 구조나 안전 로직을 변경하지 않으며,
동일한 제어 구조 하에서
반응성과 안정성 간의 정량적 트레이드오프를 조정한다.

--------------------------------------------------
1-10. Interface to PX4 Offboard Control (Roll/Pitch)
PX4 오프보드 제어 인터페이스 (Roll/Pitch)
--------------------------------------------------

The system outputs body-rate setpoints to PX4 via Offboard mode.
본 시스템은 Offboard 모드를 통해 PX4로 body-rate setpoint를 출력한다.

Roll and pitch are controlled using rate setpoints.
Roll과 pitch는 rate setpoint로 제어된다.

Braking behavior is realized by shaping the rate setpoint,
not by modifying PX4 internal controllers.
제동 동작은 PX4 내부 제어기를 수정하지 않고,
rate setpoint를 설계함으로써 구현된다.

PX4 internal controllers are responsible for low-level stabilization.
PX4 내부 제어기는 저수준 안정화를 담당한다.

--------------------------------------------------
1-10-1. Responsibility Separation Between Layers
레이어 간 책임 분리
--------------------------------------------------

The intent interpretation layer is responsible for
human input conditioning and intent safety.
의도 해석 레이어는
인간 입력의 정제와 의도 안전성을 책임진다.

PX4 is responsible for vehicle-level stabilization,
actuator limits, estimator health,
and flight safety enforcement.
PX4는 기체 수준의 안정화,
액추에이터 한계, 추정기 상태,
그리고 비행 안전 강제를 책임진다.

This separation ensures that human intent errors
and system-level failures are handled at appropriate layers.
이러한 책임 분리는
인간 의도 오류와 시스템 수준 장애가
각각 적절한 레이어에서 처리되도록 보장한다.

==================================================
2. Yaw Intent Control
Yaw 의도 제어
==================================================

[Omitted / Placeholder]
Yaw control is intentionally omitted in this version.
Yaw 제어는 본 버전에서 의도적으로 생략한다.

==================================================
3. Flex-Based Vertical (Z-axis) Intent Control
플렉스 기반 수직(Z축) 의도 제어
==================================================

Vertical motion (Z-axis) is treated differently from roll/pitch because it accumulates directly into altitude and carries higher safety risk.
수직(Z축) 운동은 고도에 직접 누적되며 안전 위험도가 크기 때문에 roll/pitch와 다르게 취급한다.

Vertical Z control maps flex intent into a vertical velocity setpoint under strict safety gating and drift-safe neutral handling.
수직 Z 제어는 플렉스 의도를 수직 속도 setpoint로 매핑하되, 엄격한 안전 게이팅과 드리프트 안전 중립 처리 하에서 동작한다.

The pipeline is defined as a single consistent control law with timers/flags, not as multiple explicit modes.
본 파이프라인은 여러 모드가 아니라 타이머/플래그를 포함한 단일 일관 제어법칙으로 정의한다.

The ENGAGED path is intentionally kept light to preserve responsiveness, assuming vehicle-level stabilization and disturbance rejection are handled by PX4.
ENGAGED 경로는 반응성을 유지하기 위해 의도적으로 “가볍게” 유지하며, 외력 보정과 안정화는 PX4가 담당한다는 가정에 기반한다.

--------------------------------------------------
3-1. Signals and Outputs (Z-axis)
신호 및 출력 정의 (Z축)
--------------------------------------------------

flex_raw: Raw flex sensor reading.
flex_raw: 플렉스 센서 원시 값.

flex_fast, flex_mid, flex_slow: Multi-timescale EMA-filtered flex signals used for slope scoring.
flex_fast, flex_mid, flex_slow: 기울기 스코어 계산을 위한 다중 시간 스케일 EMA 플렉스 신호.

flex_f: Flex signal used for command mapping (typically flex_mid or a lightly filtered stream).
flex_f: 명령 매핑에 사용하는 플렉스 신호(보통 flex_mid 또는 약한 필터 스트림).

flex_neutral: Committed neutral reference used for command mapping.
flex_neutral: 명령 매핑에 사용하는 “커밋된” 중립 기준.

neutral_candidate: Always-updated neutral candidate used as a drift-tracking estimate (not used for mapping until commit).
neutral_candidate: 드리프트 추적용으로 항상 갱신되는 중립 후보(커밋 전에는 매핑에 직접 사용하지 않음).

S_F: Flex ambiguity score derived from multi-timescale flex slope proxy (continuous scalar).
S_F: 다중 시간 스케일 플렉스 기울기 기반의 “플렉스 모호성 스코어”(연속 스칼라).

Hardgate: Large-motion hard gating event derived from arm motion thresholds (boolean/event).
Hardgate: 팔의 큰 움직임 임계값 기반 “하드 게이트”(불리언/이벤트).

Vz_cmd_raw: Vertical velocity command derived from flex displacement relative to flex_neutral (debug/diagnostic stage).
Vz_cmd_raw: flex_neutral 대비 플렉스 변위로부터 생성된 수직 속도 명령(디버그/진단 단계).

Vz_cmd_shaped: Mapped and bounded vertical velocity command after deadzone/nonlinearity/asymmetry limits.
Vz_cmd_shaped: 데드존/비선형/비대칭 제한 적용 후의 수직 속도 명령.

g_entry(t): Entry authority gain that ramps from 0→1 over ENTRY dwell time.
g_entry(t): ENGAGED 진입 시 ENTRY 체류 시간 동안 0→1로 증가하는 권한 게인.

Vz_target: Final ENGAGED target velocity after authority gain (setpoint before sending).
Vz_target: 권한 게인까지 반영된 ENGAGED 최종 목표 속도(전달 직전 setpoint).

Vz_out: Vertical velocity setpoint forwarded to PX4.
Vz_out: PX4로 전달되는 수직 속도 setpoint.

Vz_actual: Estimated vehicle vertical velocity from PX4 estimator outputs (local velocity).
Vz_actual: PX4 추정기 출력(로컬 속도)에서 얻는 기체 수직 속도 추정값.

t_since_engage: Time elapsed since ENGAGED entry (button press).
t_since_engage: ENGAGED 진입(버튼) 이후 경과 시간.

hold_active: Timer flag after safety violation that tightens gating (not a control mode).
hold_active: 안전 위반 이후 게이팅을 강화하는 타이머 플래그(제어 모드가 아님).

--------------------------------------------------
3-2. High-Level Engagement and Safety Gating
상위 ENGAGED/DISENGAGED 및 안전 게이팅
--------------------------------------------------

This Z-axis pipeline shares the high-level intent state (ENGAGED/DISENGAGED) and safety gating defined in Section 0.
Z축 파이프라인은 0번 섹션의 상위 상태(ENGAGED/DISENGAGED)와 안전 게이팅을 공유한다.

DISENGAGED: User vertical control authority is not granted, and output is driven toward zero using braking logic robust to disturbances.
DISENGAGED: 사용자 수직 제어 권한은 부여되지 않으며, 외력에도 강한 제동 로직으로 출력을 0으로 수렴시킨다.

ENGAGED: Vertical command generation is permitted, but shaped by entry ambiguity handling and strict neutral commit gating.
ENGAGED: 수직 명령 생성은 허가되지만, 진입 모호성 처리와 엄격한 중립 커밋 게이팅에 의해 성형된다.

Hard motion (arm swing) is handled by Hardgate as a hard override on neutral commit and ENTRY dwell handling only.
팔 휘두름(큰 움직임)은 Hardgate로 처리하며, 중립 커밋과 ENTRY dwell 처리에만 하드 오버라이드로 적용한다.

--------------------------------------------------
3-3. DISENGAGED Ramp-Down
DISENGAGED 램프다운
(Actual/Output Blended Braking + Output-Only Failsafe Shaping)
(actual/output 블렌딩 제동 + 출력(Vz_out) 전용 페일세이프 성형)
--------------------------------------------------

In DISENGAGED, the objective is to enforce Vz_out → 0 safely under external disturbances (wind, ground effect, estimator noise).
DISENGAGED의 목표는 외력(바람/지면효과/추정 노이즈) 환경에서도 Vz_out을 안전하게 0으로 수렴시키는 것이다.

Actual-based braking is the primary stabilizing term when |Vz_actual| is large.
|Vz_actual|이 큰 구간에서는 actual 기반 제동이 기본 안정화 항이다.

Output-based decay dominates near zero to suppress estimator noise and prevent chattering around hover.
0 근처에서는 output 기반 감쇠가 지배하여 추정 노이즈와 호버 근처 채터링을 억제한다.

Define actual braking term:
actual 제동 항을 정의한다:

Vz_brake_actual = -Kp_vz_brake · Vz_actual
Vz_brake_actual = -Kp_vz_brake · Vz_actual

Define output decay term (using previous output):
output 감쇠 항(이전 출력 사용)을 정의한다:

Vz_brake_output = -Kp_vz_out_decay · Vz_out_prev
Vz_brake_output = -Kp_vz_out_decay · Vz_out_prev

Define blending weights based on proximity of Vz_actual to zero:
Vz_actual이 0에 얼마나 가까운지에 기반한 블렌딩 가중치를 정의한다:

w_actual = clamp( |Vz_actual| / Vz_blend_ref , 0, 1 )
w_actual = clamp( |Vz_actual| / Vz_blend_ref , 0, 1 )

w_out = 1 - w_actual
w_out = 1 - w_actual

Compute DISENGAGED target:
DISENGAGED 목표값을 계산한다:

Vz_target_dis = w_actual · Vz_brake_actual + w_out · Vz_brake_output
Vz_target_dis = w_actual · Vz_brake_actual + w_out · Vz_brake_output

Apply failsafe shaping to Vz_out only (not to Vz_brake_actual internally):
페일세이프 성형은 Vz_out에만 적용한다(내부 actual 제동항 자체에 과도하게 개입하지 않음):

Vz_out = SlewJerkLimit( Vz_target_dis, dVz_fail, d²Vz_fail )
Vz_out = SlewJerkLimit( Vz_target_dis, dVz_fail, d²Vz_fail )

If Vz_actual is invalid, disable actual braking contribution:
Vz_actual이 무효이면 actual 제동 기여를 제거한다:

if w_actual = 0, w_out = 1
Vz_target_dis = Vz_brake_output

Interpretation of Vz_blend_ref:
Vz_blend_ref의 의미:

Vz_blend_ref is the speed-scale at which the system transitions from output-decay-dominant to actual-braking-dominant behavior around the target (0).
Vz_blend_ref는 목표(0) 주변에서 output 감쇠 우세 ↔ actual 제동 우세로 전환되는 속도 스케일이다.

A larger Vz_blend_ref makes the system more conservative near zero (more output decay, less reliance on estimator), while a smaller value engages actual braking earlier.
Vz_blend_ref가 크면 0 근처에서 더 보수적(추정치를 덜 믿고 output 감쇠 위주), 작으면 actual 제동이 더 빨리 개입한다.

--------------------------------------------------
3-4. Always-On Neutral Candidate Estimation
중립 후보의 상시 추정
--------------------------------------------------

Flex drift can be caused by temperature, mounting pressure, glove deformation, and fatigue bias.
플렉스 드리프트는 온도/착용 압력/장갑 변형/피로 바이어스 등으로 발생할 수 있다.

Therefore, the system maintains an always-updated neutral_candidate that tracks slow drift but does not affect command mapping until a strict commit occurs.
따라서 시스템은 느린 드리프트를 추적하는 neutral_candidate를 상시 갱신하되, 엄격한 커밋이 일어나기 전까지 명령 매핑에 영향을 주지 않도록 한다.
(Drift Tracking Without Command Jumps)
(명령 점프 없이 드리프트 추적)

Neutral candidate update (example):
중립 후보 갱신(예시):

neutral_candidate = EMA(neutral_candidate, flex_f, α_candidate_slow)
neutral_candidate = EMA(neutral_candidate, flex_f, α_candidate_slow)

The candidate estimator may run continuously in all modes, because it is gated from mapping.
후보 추정기는 매핑과 분리되어 있으므로 모든 모드에서 상시 수행해도 된다.

--------------------------------------------------
3-5. Strong-Gated Neutral Commit
강한 게이팅 기반 중립 커밋
--------------------------------------------------

Updating flex_neutral changes the mapping baseline and can create unintended commands if done at the wrong time.
flex_neutral을 갱신하면 매핑 기준이 바뀌며, 잘못된 시점에서 수행하면 의도치 않은 명령이 발생할 수 있다.
(Commit Changes Mapping, So Commit Must Be Rare and Safe)
(커밋은 매핑을 바꾸므로, 드물고 안전해야 함)

Therefore, flex_neutral is updated only via a strong-gated commit process.
따라서 flex_neutral은 강한 게이팅을 통과한 커밋 프로세스로만 갱신한다.

Commit is permitted only if all conditions are satisfied continuously for T_neutral:
커밋은 아래 조건을 T_neutral 동안 연속 만족할 때만 허용한다:

(1) Flex ambiguity is low: S_F ≤ S_neutral_th
(1) 플렉스 모호성이 낮다: S_F ≤ S_neutral_th

(2) Large-motion is absent: Hardgate == false
(2) 큰 움직임이 없다: Hardgate == false

(3) Output is near zero: |Vz_out| ≤ Vz_zero_band
(3) 출력이 0 근처다: |Vz_out| ≤ Vz_zero_band

(4) Flex is inside a strict commit band: |flex_f - flex_neutral| ≤ Δdead_commit
(4) 플렉스가 엄격한 커밋 대역 내부다: |flex_f - flex_neutral| ≤ Δdead_commit

If any condition fails, the commit dwell timer resets.
조건 하나라도 깨지면 커밋 체류 타이머는 리셋된다.

When commit triggers, update flex_neutral conservatively:
커밋이 트리거되면 flex_neutral은 보수적으로 갱신한다:

flex_neutral ← flex_neutral + k_neutral · (neutral_candidate - flex_neutral)
flex_neutral ← flex_neutral + k_neutral · (neutral_candidate - flex_neutral)

k_neutral is a small adaptation gain to prevent baseline from chasing intentional motion.
k_neutral은 baseline이 의도 움직임을 쫓아가지 않도록 하는 작은 적응 게인이다.

Note: “snap-to-current” neutral updates are not used as a default mechanism in this revision; all baseline updates are gated and slow.
비고: 본 리비전에서는 “현재값으로 점프 스냅”을 기본 메커니즘으로 사용하지 않으며, 모든 baseline 갱신은 게이팅 + 느린 갱신으로 통일한다.

--------------------------------------------------
3-6. Flex Ambiguity Score S_F
플렉스 모호성 스코어 S_F
--------------------------------------------------

Differentiation amplifies noise, so S_F is computed using multi-timescale EMA differences rather than raw derivatives.
미분은 노이즈를 증폭하므로, S_F는 원시 미분이 아니라 다중 시간 스케일 EMA 차분으로 계산한다.

Maintain three EMA streams:
EMA 3개 스트림을 유지한다:

flex_fast = EMA(flex_raw, α_fast)
flex_fast = EMA(flex_raw, α_fast)

flex_mid = EMA(flex_raw, α_mid)
flex_mid = EMA(flex_raw, α_mid)

flex_slow = EMA(flex_raw, α_slow) (α_slow < α_mid < α_fast)
flex_slow = EMA(flex_raw, α_slow) (α_slow < α_mid < α_fast)

Compute two slope proxies (time-scale separation via τ_eff):
기울기 프록시 2개를 계산한다(τ_eff로 유효 시간 분리 반영):

Δ_fm = (flex_fast - flex_mid) / τ_fm
Δ_fm = (flex_fast - flex_mid) / τ_fm

Δ_ms = (flex_mid - flex_slow) / τ_ms
Δ_ms = (flex_mid - flex_slow) / τ_ms

Combine them with higher sensitivity to recent motion:
최근 움직임에 더 민감하도록 가중 결합한다:

dFlex_est = w_fm · Δ_fm + w_ms · Δ_ms
dFlex_est = w_fm · Δ_fm + w_ms · Δ_ms

Typical constraint: w_fm > w_ms and (w_fm + w_ms) normalized for consistent scale.
일반 제약: w_fm > w_ms 이며, (w_fm + w_ms)는 스케일 일관성을 위해 정규화한다.

Map dFlex_est magnitude into a bounded ambiguity score:
dFlex_est 크기를 [0,1]로 제한된 모호성 스코어로 매핑한다:

S_F = clamp( |dFlex_est| / dFlex_ref , 0, 1 )
S_F = clamp( |dFlex_est| / dFlex_ref , 0, 1 )

dFlex_ref is obtained by calibration (Section 3-13) to reflect typical sensor noise and tremor level for the current wearing condition.
dFlex_ref는 캘리브레이션(3-13)으로 구해 현재 착용 조건에서의 일반 노이즈/떨림 수준을 반영한다.

S_F is used for ENTRY dwell base time and ENTRY deadzone expansion base value.
S_F는 ENTRY 체류 시간의 기본값과 ENTRY 데드존 확장 기본값에 사용된다.

--------------------------------------------------
3-7. Hardgate: Large-Motion Hard Gating
하드게이트: 큰 움직임 하드 게이팅
--------------------------------------------------

Hardgate is a binary large-motion safety event derived from arm-motion thresholds and is not blended as a soft score.
Hardgate는 팔 움직임 임계값으로부터 생성되는 이진(불리언) 큰-움직임 안전 이벤트이며 소프트 스코어로 블렌딩하지 않는다.

Hardgate is monitored continuously in all high-level states (ENGAGED/DISENGAGED) and in all sub-phases (including ENTRY).
Hardgate는 상위 상태(ENGAGED/DISENGAGED) 및 모든 서브 구간(ENTRY 포함)에서 상시 감시된다.

Hardgate triggers when either of the following holds:
Hardgate는 아래 조건 중 하나라도 만족하면 트리거된다:

Hardgate = (|gyro| ≥ gyro_hi) OR (||acc|| − 1g ≥ acc_hi).
Hardgate = (|gyro| ≥ gyro_hi) OR (||acc|| − 1g ≥ acc_hi).

Hardgate affects only (a) neutral commit gating and (b) ENTRY dwell behavior; it does not constrain Z output outside ENTRY dwell.
Hardgate는 (a) 중립 커밋 게이팅과 (b) ENTRY dwell 동작에만 영향을 주며, ENTRY dwell 밖에서는 Z 출력에 제한을 가하지 않는다.

While Hardgate is true, neutral commit is forbidden.
Hardgate가 true인 동안 중립 커밋은 금지된다.

Hardgate persistence is tracked continuously using a timer t_hard_persist.
Hardgate의 지속시간은 타이머 t_hard_persist로 상시 추적한다.

If Hardgate becomes false, t_hard_persist is reset to zero immediately.
Hardgate가 false로 돌아오면 t_hard_persist는 즉시 0으로 초기화한다.

If Hardgate remains continuously true longer than T_hard_persist_max, DISENGAGED is enforced as a safety override regardless of ENTRY.
Hardgate가 T_hard_persist_max보다 오래 연속 유지되면 ENTRY 여부와 무관하게 안전 오버라이드로 DISENGAGED를 강제한다.

Parameters (Hardgate): gyro_hi, acc_hi, T_hard_persist_max.
파라미터(Hardgate): gyro_hi, acc_hi, T_hard_persist_max.

--------------------------------------------------
3-8. Engagement-Entry Handling (ENTRY Dwell)
ENGAGED 진입 처리(ENTRY dwell)
--------------------------------------------------

Upon ENGAGED entry (button press), the system starts an ENTRY dwell to handle flex ambiguity at engagement onset.
ENGAGED 진입(버튼 입력) 시점의 플렉스 모호성을 처리하기 위해 시스템은 ENTRY dwell을 시작한다.

ENTRY dwell grants output authority via an authority gain g_entry(t) that ramps from 0 to 1.
ENTRY dwell은 권한 게인 g_entry(t)를 0에서 1로 램프업하여 출력 권한을 부여한다.

Define the base dwell time from the flex ambiguity score at the entry instant:
진입 순간의 플렉스 모호성 스코어로 기본 dwell 시간을 정의한다:

T_dwell_entry_base = clamp(T_entry_min + K_entry · S_F_entry, T_entry_min, T_entry_max).
T_dwell_entry_base = clamp(T_entry_min + K_entry · S_F_entry, T_entry_min, T_entry_max).

Set the dwell time for the current ENTRY window as:
현재 ENTRY 구간의 dwell 시간은 다음으로 둔다:

T_dwell_entry = T_dwell_entry_base.
T_dwell_entry = T_dwell_entry_base.

Define the ENTRY progress and smoothstep gain:
ENTRY 진행도와 smoothstep 게인을 정의한다:

u = clamp(t_since_engage / T_dwell_entry, 0, 1).
u = clamp(t_since_engage / T_dwell_entry, 0, 1).

g_entry(t) = 3u² − 2u³.
g_entry(t) = 3u² − 2u³.

During ENTRY dwell, the commanded Z target is:
ENTRY dwell 동안 Z 목표 명령은 다음과 같다:

Vz_target = g_entry(t) · Vz_cmd_shaped.
Vz_target = g_entry(t) · Vz_cmd_shaped.

Hardgate handling inside ENTRY dwell:
ENTRY dwell 내부에서의 Hardgate 처리:

If a Hardgate event is detected during ENTRY dwell, the system resets the ENTRY dwell timer to re-observe stability.
ENTRY dwell 중 Hardgate 이벤트가 감지되면 안정성 재관측을 위해 ENTRY dwell 타이머를 리셋한다.

On each reset: t_since_engage ← 0 and N_reset ← N_reset + 1.
리셋 시마다: t_since_engage ← 0, N_reset ← N_reset + 1.

Reset retries are bounded; if N_reset exceeds N_reset_max, DISENGAGED is enforced.
리셋 재시도는 제한되며 N_reset이 N_reset_max를 초과하면 DISENGAGED를 강제한다.

To prevent indefinite entry-lock, enforce a hard cap on total ENTRY elapsed time T_entry_total_max; if exceeded, DISENGAGED is enforced.
무한 진입 잠금을 방지하기 위해 ENTRY 총 경과시간 상한 T_entry_total_max를 강제하며 초과 시 DISENGAGED를 강제한다.

DISENGAGED enforcement during ENTRY is triggered by the logical OR of: (Hardgate persistence), (reset overflow), or (ENTRY total timeout).
ENTRY 중 DISENGAGED 강제 조건은 (Hardgate 지속), (리셋 횟수 초과), (ENTRY 총시간 초과) 중 하나라도 만족(OR)이다.

Parameters (ENTRY dwell): T_entry_min, T_entry_max, K_entry, N_reset_max, T_entry_total_max.
파라미터(ENTRY dwell): T_entry_min, T_entry_max, K_entry, N_reset_max, T_entry_total_max.

--------------------------------------------------
3-8-1. Temporary Output Cap During Restarted ENTRY (Optional)
리셋된 ENTRY 동안 임시 출력 캡(선택)
--------------------------------------------------

If repeated Hardgate resets cause a harsh “output drop” sensation, apply a temporary cap to the shaped command during restarted ENTRY.
Hardgate 리셋이 반복될 때 “출력이 과하게 꺼지는 느낌”이 크면, 리셋된 ENTRY 동안 성형 명령에 임시 캡을 적용한다.

When a Hardgate event occurs at time t_e during ENTRY, record the pre-event magnitude of the shaped command:
ENTRY 중 t_e 시점에 Hardgate가 발생하면, 이벤트 직전 성형 명령 크기를 기록한다:

Vz_hold = Vz_cmd_shaped(t_e⁻).
Vz_hold = Vz_cmd_shaped(t_e⁻).

Define the per-event attenuation ratio r_cap = 1 − N_cap, with N_cap ∈ (0, 1).
이벤트당 감쇠 비율 r_cap = 1 − N_cap로 정의하며 N_cap ∈ (0, 1)이다.

Initialize the cap magnitude for the restarted dwell as:
리셋된 dwell에서의 캡 크기를 다음으로 초기화한다:

Vz_cap = r_cap · Vz_hold.
Vz_cap = r_cap · Vz_hold.

During the restarted dwell (while g_entry(t) < 1), enforce:
리셋된 dwell 동안(g_entry(t) < 1인 동안) 다음을 강제한다:

|Vz_cmd_shaped| ≤ |Vz_cap|.
|Vz_cmd_shaped| ≤ |Vz_cap|.

If additional Hardgate events occur within the same ENTRY window, update the cap multiplicatively:
동일 ENTRY 구간에서 Hardgate가 추가로 발생하면 캡을 누적 감쇠로 갱신한다:

Vz_cap ← r_cap · Vz_cap (per event).
Vz_cap ← r_cap · Vz_cap (이벤트당).

The cap is removed automatically once ENTRY completes (g_entry(t) = 1).
ENTRY가 완료되면(g_entry(t)=1) 캡은 자동 해제된다.

The cap is never applied outside ENTRY dwell.
캡은 ENTRY dwell 밖에서는 절대 적용하지 않는다.

Parameters (cap): N_cap.
파라미터(캡): N_cap.

--------------------------------------------------
3-9. Entry Deadzone Expansion and Recovery
진입 데드존 확장 및 복귀
--------------------------------------------------

(Deadzone Width Set by S_F; Shrink Restricted by Hardgate/Hold)
(S_F로 폭 결정; Hardgate/Hold가 축소를 제한)

During ENGAGED entry, deadzone width is expanded as a function of flex ambiguity to prevent unintended motion.
ENGAGED 진입 동안 데드존 폭은 플렉스 모호성의 함수로 확장되어 의도치 않은 움직임을 방지한다.

Define entry deadzone width from S_F at entry:
진입 시점 S_F로 진입 데드존 폭을 정의한다:

-Δdead_entry = clamp( Δdead_nom + K_dead · S_F_entry , Δdead_nom, Δdead_entry_max )

During entry dwell, use deadzone_width = Δdead_entry.
ENTRY 체류 동안 deadzone_width = Δdead_entry를 사용한다.

After entry dwell completes, deadzone is allowed to recover toward nominal, but shrink is lower-bounded when Hardgate or hold_active is true.
ENTRY 종료 후 데드존은 정상값으로 복귀 가능하지만, Hardgate 또는 hold_active가 true이면 축소 하한이 적용된다.

Define shrink lower bound:
축소 하한을 정의한다:

-Δdead_min_guard = max( Δdead_nom, Δdead_guard_min )

If (Hardgate == true) OR (hold_active == true), enforce: deadzone_width ≥ Δdead_min_guard.
(Hardgate==true) 또는 (hold_active==true)면 deadzone_width ≥ Δdead_min_guard를 강제한다.

--------------------------------------------------
3-10. Flex-to-Vz Command Mapping
플렉스→Vz 명령 매핑
--------------------------------------------------

(Deadzone + Nonlinearity + Asymmetric Limits)
(데드존 + 비선형 + 비대칭 제한)

Compute flex displacement relative to committed neutral:
커밋된 중립 기준 대비 플렉스 변위를 계산한다:

-δ = flex_f - flex_neutral

Apply deadzone:
데드존 적용:

-if |δ| ≤ deadzone_width: δ_eff = 0
-else: δ_eff = sign(δ) · (|δ| - deadzone_width)

Map to vertical velocity using a monotonic nonlinear function φ(·):
단조 비선형 함수 φ(·)로 수직 속도로 매핑한다:

-Vz_cmd_raw = K_flex_z · φ(δ_eff)

Recommended φ(·) candidates include x²-like shaping or smoothstep-like shaping; selection is experimental.
φ(·)는 x² 계열 또는 smoothstep 계열이 유력하며, 선택은 실험으로 결정한다.

Apply asymmetric limits to reduce perceived risk on descent:
하강 체감 위험을 낮추기 위해 비대칭 제한을 적용한다:

-Vz_cmd_shaped = clamp( Vz_cmd_raw, -Vz_down_lim, +Vz_up_lim )

Constraint: Vz_down_lim < Vz_up_lim (more conservative descent).
제약: Vz_down_lim < Vz_up_lim (하강을 더 보수적으로).

Note: Vz_cmd_raw is retained for debugging and diagnostics, not because an additional control stage is required.
비고: Vz_cmd_raw는 추가 제어 단계가 필요해서가 아니라 디버깅/진단을 위해 유지한다.

--------------------------------------------------
3-11. ENGAGED Output Forwarding Policy
ENGAGED 출력 전달 정책
--------------------------------------------------

(Minimal Shaping in ENGAGED)
(ENGAGED에서는 최소 성형)

In ENGAGED, the system forwards Vz_target as the setpoint after entry authority shaping and mapping bounds.
ENGAGED에서는 ENTRY 권한 성형과 매핑 제한을 거친 Vz_target을 setpoint로 전달한다.

Additional slew/jerk limiting on Vz_out is not applied by default in ENGAGED to avoid degrading the benefit of actual-based stabilization handled by PX4.
ENGAGED에서 Vz_out에 추가 변화율/저크 제한은 기본적으로 적용하지 않으며, PX4가 수행하는 actual 기반 안정화의 장점을 훼손하지 않도록 한다.

If hardware protection requires limiting, it must be applied conservatively and only after confirming it does not dominate system response.
하드웨어 보호를 위해 제한이 필요하다면, 시스템 응답을 지배하지 않는 선에서 보수적으로만 적용해야 한다.
--------------------------------------------------
3-12. Vz_actual Source and Validity
Vz_actual 획득 및 유효성
--------------------------------------------------

Vz_actual is sourced from PX4 estimator outputs (local velocity).
Vz_actual은 PX4 추정기 출력(로컬 속도)에서 획득한다.

Vz_actual is valid only if the estimator stream is fresh and healthy:
Vz_actual은 추정기 스트림이 신선하고 정상일 때만 유효하다:

Timestamp freshness: (t_now - t_vz) ≤ T_vz_fresh
타임스탬프 신선도: (t_now - t_vz) ≤ T_vz_fresh

Estimator validity: EKF/local velocity validity flags OK
추정기 유효성: EKF/로컬 속도 유효 플래그 정상

Numeric validity: finite (not NaN/Inf) and bounded magnitude
수치 유효성: 유한값(NaN/Inf 아님)이며 크기 제한 범위 내

If invalid, DISENGAGED falls back to output decay only (w_actual=0).
무효이면 DISENGAGED는 output 감쇠만 사용한다(w_actual=0).

--------------------------------------------------
3-13. Hold Flag After Safety Violation
안전 위반 이후 홀드 플래그
--------------------------------------------------

After any safety gating violation, a hold flag is asserted for T_hold_L.
안전 게이팅 위반 이후 홀드 플래그를 T_hold_L 동안 유지한다.

hold_active = true for T_hold_L
hold_active = true for T_hold_L

hold_active is not a control mode; it is a gating intensifier for sensitive operations.
hold_active는 제어 모드가 아니라 민감 동작에 대한 게이팅 강화자이다.

While hold_active is true:
hold_active가 true인 동안:

(1) Neutral commit is forbidden or made strictly conservative (recommended: forbidden).
(1) 중립 커밋은 금지 또는 극단적으로 보수화(권장: 금지).

(2) Deadzone shrink is restricted by enforcing a lower bound (deadzone_width ≥ Δdead_min_guard).
(2) 데드존 축소는 하한을 강제하여 제한한다(deadzone_width ≥ Δdead_min_guard).

(3) ENTRY dwell is not allowed to be “accelerated”; Hardgate-based extensions remain valid.
(3) ENTRY 체류는 “가속”을 허용하지 않으며, Hardgate 기반 연장은 유효하다.

This ensures that immediately after a safety event, the system remains conservative until stability is re-observed.
이는 안전 이벤트 직후 시스템이 안정성을 다시 관측할 때까지 보수성을 유지하게 한다.

--------------------------------------------------
3-14. Calibration for Robust Parameterization
견고한 파라미터화를 위한 캘리브레이션
--------------------------------------------------

(Initialization + Noise Statistics)
(초기화 + 노이즈 통계)

To reduce tuning chaos, key thresholds are initialized by a short calibration window at startup.
튜닝 지옥을 줄이기 위해 주요 임계값은 시작 시 짧은 캘리브레이션 윈도우로 초기화한다.

Calibration window duration: T_cal_init (e.g., 3 seconds).
캘리브레이션 윈도우 길이: T_cal_init (예: 3초).

During calibration, the operator must keep the flex and arm motion stable (no intentional input).
캘리브레이션 동안 사용자는 플렉스/팔 움직임을 안정적으로 유지해야 한다(의도 입력 금지).

Compute statistics on flex slope proxy to set dFlex_ref and nominal deadzone scale.
플렉스 기울기 프록시의 통계를 계산하여 dFlex_ref와 정상 데드존 스케일을 설정한다.

Example: dFlex_ref set from percentile or k·σ of |dFlex_est| distribution.
예시: dFlex_ref는 |dFlex_est| 분포의 퍼센타일 또는 k·σ로 설정한다.

Similarly, nominal deadzone Δdead_nom can be initialized from flex noise statistics.
정상 데드존 Δdead_nom도 플렉스 노이즈 통계로 초기화할 수 있다.

Hardgate thresholds (gyro_hi, acc_hi) remain safety-critical and are set conservatively, not learned online.
Hardgate 임계값(gyro_hi, acc_hi)은 안전 핵심이므로 온라인 학습이 아니라 보수적으로 고정 설정한다.

--------------------------------------------------
3-15. Open Parameters for Experimental Tuning
실험 기반 튜닝 파라미터(상세 설명)
--------------------------------------------------

The following parameters are tuned experimentally to balance
responsiveness, stability, drift-robustness, and perceived safety
under human-in-the-loop vertical control.
다음 파라미터들은 인간 개입 수직 제어에서
반응성, 안정성, 드리프트 견고성, 체감 안전성의 균형을 위해
실험적으로 튜닝된다.

(1) Multi-EMA slope / S_F parameters
(1) 다중 EMA 기울기 / S_F 파라미터

α_fast, α_mid, α_slow
: EMA coefficients defining the time scales used to compute multi-timescale slope proxies.
α_fast is most responsive; α_slow is most stable.
: 다중 시간 스케일 기울기 프록시 계산에 사용하는 EMA 시간 스케일 계수.
α_fast는 가장 민감, α_slow는 가장 안정.

τ_fm, τ_ms
: Effective time-separation constants used to scale (fast-mid) and (mid-slow) difference terms into slope proxies.
: (fast-mid), (mid-slow) 차분 항을 기울기 프록시로 스케일링하기 위한 유효 시간 분리 상수.

w_fm, w_ms
: Combination weights for Δ_fm and Δ_ms (recommended: w_fm > w_ms for higher sensitivity to recent motion).
: Δ_fm, Δ_ms 결합 가중치(권장: 최근 움직임에 더 민감하도록 w_fm > w_ms).

dFlex_ref
: Normalization reference that maps |dFlex_est| into [0,1] for S_F.
Initialized by calibration to reflect current wearing noise/tremor conditions.
: |dFlex_est|를 [0,1]로 매핑하기 위한 정규화 기준치.
착용 조건의 노이즈/떨림 수준을 반영하도록 캘리브레이션으로 초기화.

S_neutral_th
: Ambiguity threshold below which neutral commit can be considered (lower = stricter commit).
: 중립 커밋을 고려할 수 있는 모호성 임계값(낮을수록 커밋이 더 엄격).

(2) ENTRY dwell / extension parameters
(2) ENTRY 체류 / 연장 파라미터

T_entry_min, T_entry_max
: Minimum/maximum base dwell time applied at ENGAGED entry.
Bounds the S_F-based dwell scheduling.
: ENGAGED 진입 시 적용되는 체류 시간 기본값의 최소/최대.
S_F 기반 dwell 스케줄링의 상한/하한을 강제.

K_entry
: Gain mapping S_F_entry into base dwell time.
Larger K_entry increases conservativeness at ambiguous entry.
: S_F_entry를 dwell 기본값으로 변환하는 게인.
K_entry가 클수록 진입 모호성에서 더 보수적.

N_reset_max
: Maximum number of ENTRY dwell resets allowed due to Hardgate events (prevents infinite re-entry loops).
: Hardgate 이벤트로 인해 허용되는 ENTRY dwell 리셋 최대 횟수(무한 루프 방지).

N_cap (optional)
: Output attenuation fraction applied to the pre-event command magnitude during restarted ENTRY to reduce harsh output drops.
: 리셋된 ENTRY 동안 이벤트 직전 명령 크기에 적용하는 출력 감쇠 비율(급격한 출력 드롭 완화).

T_hard_persist_max
: Maximum continuous Hardgate duration before enforcing DISENGAGED (safety escalation).
: Hardgate 연속 지속 허용 상한(초과 시 DISENGAGED 강제).

T_entry_total_max
: Absolute cap on total ENTRY time across resets (prevents indefinite entry-lock).
: 리셋을 포함한 ENTRY 총시간 절대 상한(무한 진입 잠금 방지).

N_ext_max, T_entry_hard_max (if extension logic is used)
: Limits on how many dwell extensions are allowed and the absolute maximum dwell even with extensions.
: dwell 연장 로직을 사용할 경우, 연장 횟수 상한 및 연장 포함 절대 체류시간 상한.

(3) Deadzone parameters
(3) 데드존 파라미터

Δdead_nom
: Nominal deadzone width during steady operation to suppress tremor/noise without killing controllability.
: 정상 운용에서 떨림/노이즈를 억제하면서 조작성을 해치지 않는 데드존 폭.

K_dead
: Gain mapping S_F_entry into entry deadzone expansion.
Higher values increase safety against unintended motion at entry.
: S_F_entry를 진입 데드존 확장으로 매핑하는 게인.
클수록 진입 시 의도치 않은 움직임에 더 안전.

Δdead_entry_max
: Maximum deadzone width allowed during entry to avoid excessive loss of controllability.
: 진입 시 허용되는 데드존 최대 폭(조작성 붕괴 방지).

Δdead_commit
: Strict commit band width for neutral commit gating (must be smaller than Δdead_nom).
: 중립 커밋 게이팅용 엄격 대역 폭(Δdead_nom보다 작아야 함).

Δdead_guard_min
: Lower bound on deadzone width enforced under Hardgate/hold_active to prevent aggressive shrink immediately after instability/safety events.
: Hardgate/hold_active 상태에서 데드존 축소 하한으로 강제되는 값(안정성 재관측 전 과감한 축소 방지).

(4) Mapping / limits parameters
(4) 매핑 / 제한 파라미터

K_flex_z
: Gain mapping flex displacement (relative to committed neutral) into vertical velocity command magnitude.
: 커밋된 중립 대비 플렉스 변위를 수직 속도 명령 크기로 매핑하는 게인.

φ(·)
: Monotonic nonlinear mapping function shaping sensitivity (candidate: x²-like or smoothstep-like).
Determines fine-control feel near zero vs. aggressiveness at large displacement.
: 단조 비선형 매핑 함수(후보: x² 계열 또는 smoothstep 계열).
0 근처 미세 조작감 vs 큰 변위에서의 공격성을 결정.

Vz_up_lim, Vz_down_lim
: Asymmetric vertical velocity limits (recommended: more conservative descent, i.e., Vz_down_lim < Vz_up_lim).
: 비대칭 수직 속도 제한(권장: 하강을 더 보수적으로, Vz_down_lim < Vz_up_lim).

(5) DISENGAGED braking / shaping parameters
(5) DISENGAGED 제동 / 성형 파라미터

Kp_vz_brake
: P gain for actual-based braking term (-Kp·Vz_actual).
Controls disturbance-robust ramp-down when the vehicle has significant vertical motion.
: actual 기반 제동 항(-Kp·Vz_actual)의 P 게인.
기체 수직 속도가 큰 구간에서 외력에 강한 램프다운을 결정.

Kp_vz_out_decay
: Decay gain for output-based braking term (-Kp·Vz_out_prev).
Dominates near zero to suppress estimator noise and prevent chattering.
: output 기반 감쇠 제동(-Kp·Vz_out_prev) 게인.
0 근처에서 추정 노이즈/채터링 억제를 위해 지배.

Vz_blend_ref
: Speed-scale that sets the transition between actual-braking dominance and output-decay dominance near zero.
: 0 근처에서 actual 제동 우세 ↔ output 감쇠 우세 전환을 결정하는 속도 스케일.

dVz_fail, d²Vz_fail
: Failsafe slew-rate and jerk limits applied to Vz_out only in DISENGAGED to guarantee bounded stopping behavior.
: DISENGAGED에서 Vz_out에만 적용되는 페일세이프 변화율/저크 제한(정지 동작 상한 보장).

T_vz_fresh
: Maximum allowable estimator age for considering Vz_actual valid.
: Vz_actual 유효성 판단을 위한 추정기 최대 허용 지연.

(6) Hardgate parameters (safety-critical)
(6) Hardgate 파라미터 (안전 핵심)

gyro_hi
: High threshold on gyro magnitude indicating large arm motion that must hard-gate sensitive operations.
: 큰 팔 움직임을 의미하는 자이로 크기 고임계값(민감 동작 하드 게이트).

acc_hi
: High threshold on |acc|-1g indicating strong acceleration disturbance / swing motion.
: 큰 가속 교란/휘두름을 의미하는 |acc|-1g 고임계값.

T_hard_persist_max (shared with ENTRY escalation)
: Maximum continuous Hardgate duration allowed before forcing DISENGAGED.
: Hardgate 연속 지속 허용 상한(초과 시 DISENGAGED 강제).

(7) Hold parameters
(7) 홀드 파라미터

T_hold_L
: Hold duration after any safety gating violation, during which sensitive operations are tightened
(e.g., neutral commit forbidden, deadzone shrink restricted).
: 안전 게이팅 위반 이후 민감 동작을 강화하는 홀드 지속 시간
(예: 중립 커밋 금지, 데드존 축소 제한).

Note:
These parameters do not change the system’s structural safety rules,
but determine the quantitative trade-offs between responsiveness, stability, and perceived safety under the same architecture.
비고:
이 파라미터들은 시스템 구조/안전 규칙을 바꾸지 않으며,
동일한 구조 하에서 반응성-안정성-체감 안전성의 정량적 트레이드오프를 결정한다.

--------------------------------------------------
3-16. Summary of Key Behavioral Guarantees
핵심 동작 보장 요약
--------------------------------------------------

No ACTIVE/LIMITED split is required because entry ambiguity and stability are handled by S_F-based dwell, Hardgate-based extensions, and strong neutral commit gating.
ACTIVE/LIMITED 분리가 필요 없는 이유는 진입 모호성과 안정성을 S_F 기반 체류, Hardgate 기반 연장, 강한 중립 커밋 게이팅으로 해결하기 때문이다.

Neutral drift is tracked continuously by neutral_candidate but only affects mapping through strict commits.
중립 드리프트는 neutral_candidate로 상시 추적되지만, 엄격한 커밋을 통해서만 매핑에 반영된다.

Large arm motion never softly “blends”; it hard-gates sensitive operations and can force DISENGAGED if persistent.
큰 팔 움직임은 소프트 블렌딩하지 않고 민감 동작을 하드 게이트하며, 지속 시 DISENGAGED 강제까지 가능하다.

DISENGAGED ramp-down is robust to disturbances by using actual/output blended braking and applying failsafe shaping only on the final output Vz_out.
DISENGAGED 램프다운은 actual/output 블렌딩 제동으로 외력에 강하며, 페일세이프 성형은 최종 출력 Vz_out에만 적용한다.

Hardgate does not constrain output outside ENTRY dwell; it only escalates to DISENGAGED if abnormal persistence is detected.
Hardgate는 ENTRY dwell 밖에서 출력에 개입하지 않으며, 비정상 지속이 감지될 때만 DISENGAGED로 승격한다.

During ENTRY dwell, Hardgate triggers bounded resets and a proportional output cap to preserve continuity while re-establishing stability.
ENTRY dwell 동안 Hardgate는 재시도 제한 리셋과 비율 기반 출력 캡을 트리거하여, 연속성을 유지하면서 안정성을 재확립한다.

==================================================

1.roll/pitch demand shaping: P_value→g(P)→rate_setpoint, DISENGAGED 0 수렴
2.z 파이프라인: ENTRY dwell + Hardgate reset/cap + neutral_candidate/commit + hold_active
3.게이팅/Fail-safe: offboard heartbeat loss, estimator invalid, 입력 NaN/spike
4.테스트 시나리오 통과(네가 위에 붙인 8개 케이스)


권장 초기값 (Roll/Pitch)
1) Minimum authority gain a
추천: a = 0.15 ~ 0.25 (시작은 0.20)
의미: 저수요(낮은 demand) 구간에서도 완전 무권한 느낌/데드존을 막는 최소 전달비율
튜닝 팁:
조작이 “끊긴다/답답하다” → a↑
저수요에서 흔들림/잡진동이 남는다 → a↓ + 제동쪽(K_floor/T_stop) 조정
2) Smoothstep 경계 P_low, P_high
핵심은 “P_value가 0~1로 정규화”돼 있다는 전제에서 추천.
추천 시작값:
P_low = 0.15
P_high = 0.55 (대부분 여기서 시작하면 무난함)
튜닝 팁:
초반에 너무 빨리 “강한 demand”로 넘어가서 제동이 잘 안 걸림 → P_high↑ 또는 Kp_intent↓
반대로 반응이 둔하고 제동이 과하게 개입 → P_low↓ 또는 P_high↓ 또는 Kp_intent↑
3) Low-demand 체류 시간 T_stop
추천: T_stop = 0.35 ~ 0.60 s (시작은 0.45 s)
의미: P_value ≤ P_low일 때 제동 강화가 누적되는 시간상수(“완전 정지 느낌” 만드는 시간)
튜닝 팁:
손 놓아도 미세하게 남아있다(잔속도) → T_stop↓ 또는 K_floor↑
손 놓았을 때 너무 “확” 멈춰서 불쾌/급정지 → T_stop↑ 또는 K_floor↓
4) Braking floor gain K_floor
단위는 rate_setpoint = -K_floor * actual_rate라서 무차원(비율)로 보면 됨.
추천: K_floor = 0.6 ~ 1.0 (시작은 0.8)
안전한 범위: 보통 0.5~1.2 안에서 시작하는 게 무난
튜닝 팁:
저수요에서 “멈추는 힘” 부족 → K_floor↑
저수요에서 제동이 과해서 조작감이 딱딱/오버댐핑 → K_floor↓
5) Authority scaling Kp_intent
정의: P_value = clamp(Kp_intent * e_mag, 0, 1)
→ e_mag가 어느 정도면 P_value가 1 근처를 찍을지를 정하면 됨.
설계 목표를 먼저 잡자:
“e_mag = e_sat일 때 P_value = 1”로 두면
Kp_intent = 1 / e_sat
추천 초기 설계값:
e_sat = 1.0 rad/s (≈ 57 deg/s) 기준으로 시작
⇒ Kp_intent = 1.0
대안(더 공격적/더 보수적):
더 빨리 강한 demand로 치고 올라가게(제동 덜, 반응 빠름): e_sat=0.7 → Kp≈1.4
더 보수적으로(제동 더, 안정감): e_sat=1.4 → Kp≈0.7
추천 스타트: Kp_intent = 1.0, P_low=0.15, P_high=0.55, a=0.20, T_stop=0.45s, K_floor=0.8
빠른 체크 시나리오 (튜닝 순서)
a=0.20 고정 → “데드존 체감”만 먼저 잡기
K_floor로 저수요 정지감 잡기
T_stop으로 “멈추는 시간감” 조정
마지막에 Kp_intent / P_low / P_high로 제동↔권한 전이 타이밍 맞추기

기본 전제
루프 주기: 100 Hz (dt=0.01s) 기준 (50 Hz면 α 값만 살짝 낮추면 됨)
Vz setpoint 단위: m/s
body rate 단위: rad/s (PX4 offboard도 보통 rad/s)

1) Multi-EMA + S_F (flex slope proxy)
EMA 계수 (dt=0.01s 기준, 시간상수 τ로 설계)
EMA는 보통 y += α (x-y), 여기서 α = dt/(τ+dt).
τ_fast = 0.05 s → α_fast ≈ 0.167
τ_mid = 0.25 s → α_mid ≈ 0.038
τ_slow = 1.00 s → α_slow ≈ 0.0099
이 조합이면 fast-mid가 “최근 미세 움직임”, mid-slow가 “느린 드리프트/자세변화”를 잘 분리함.
τ_fm, τ_ms (기울기 프록시 분모)
τ_fm = 0.20 s
τ_ms = 0.80 s
(대충 fast-mid는 0.2초 스케일, mid-slow는 0.8초 스케일로 기울기를 해석)
가중치
w_fm = 0.75
w_ms = 0.25
(정규화되어 합 1.0)
dFlex_ref (S_F 정규화 기준)
이건 고정 숫자 박지 말고 캘리브레이션으로 잡아.
캘리브레이션(3s) 동안 |dFlex_est| 샘플들에서
dFlex_ref = P95(|dFlex_est|) (추천)
또는 dFlex_ref = 3σ(|dFlex_est|)
P95가 실사용에서 더 견고함(가끔 튀는 노이즈를 너무 키우지 않음).
S_neutral_th (neutral commit 허용 임계)
S_neutral_th = 0.20 (초기)
너무 빡빡하면 0.25
너무 헐거우면 0.15
2) ENTRY dwell / reset / cap
ENTRY 시간
T_entry_min = 0.30 s
T_entry_max = 1.20 s
K_entry = 0.90 s
→ T_dwell_entry_base = clamp(0.30 + 0.90*S_F_entry, 0.30, 1.20)
Hardgate reset 한도
N_reset_max = 3
T_entry_total_max = 3.5 s
(리셋 반복으로 진입 잠금 방지)
Hardgate 지속 DISENGAGED
T_hard_persist_max = 0.60 s
(팔 휘두름이 0.6초 이상 “연속”이면 비정상으로 보고 끊음)
(옵션) restarted ENTRY cap
N_cap = 0.30 → r_cap = 0.70
너무 많이 꺼지는 느낌이면 N_cap 0.2
계속 튀면 N_cap 0.35
3) Deadzone 관련
여기는 flex raw 스케일이 장갑/센서마다 달라서 **“노이즈 통계 기반 자동 설정”**이 핵심.
Δdead_nom (정상 데드존)
캘리브레이션 동안 flex_f - flex_neutral의 표준편차를 σ_f라 하면:
Δdead_nom = 3σ_f (추천)
최소값 가드: Δdead_nom ≥ 2σ_f
Δdead_entry_max (진입 시 최대)
Δdead_entry_max = 2.5 * Δdead_nom
K_dead (S_F_entry → deadzone 확장)
확장식이 Δdead_entry = clamp(Δdead_nom + K_dead*S_F_entry, …)라면
K_dead = 1.5 * Δdead_nom
→ S_F_entry=1일 때 Δdead_entry가 2.5Δdead_nom 근처로 가게 맞춰짐
Δdead_commit (커밋 대역: 더 엄격)
Δdead_commit = 0.5 * Δdead_nom
(“정말 중립 근처에서만 커밋”)
Δdead_guard_min (Hardgate/hold에서 축소 하한)
Δdead_guard_min = 1.2 * Δdead_nom

4) Flex→Vz 매핑/제한
상승/하강 속도 제한 (초기 보수)
Vz_up_lim = +0.8 m/s
Vz_down_lim = 0.4 m/s (즉, clamp 하강은 -0.4)
실내/저고도면 더 보수적으로: up 0.5, down 0.25

K_flex_z
이것도 flex 스케일에 따라 달라서 “정규화 후” 잡는 게 좋다.
추천 방식:
δ_eff_norm = δ_eff / (δ_ref) 형태로 한 번 정규화하고
그 다음 K_flex_z = Vz_up_lim 처럼 해버리면 튜닝이 쉬움.
여기서 δ_ref는 “사용자가 의도적으로 크게 굽혔을 때”의 δ_eff 값(간단 캘리브레이션 1초 추가로 측정 가능)
정규화 안 하고 raw로 하면 초기값 의미가 없음.
φ(·) (비선형)
초기에는 부드럽고 단조인 게 좋음:
φ(x) = sign(x) * (|x|^2) (정규화된 x 기준)
또는 smoothstep 계열 (특히 0 근처 완만)

5) DISENGAGED 브레이킹/성형
Kp_vz_brake (actual 기반 제동)

Kp_vz_brake = 1.2 (단위: 1/s 느낌)
과하게 튕기면 0.8
너무 미적지근하면 1.5

Kp_vz_out_decay (output 기반 감쇠)
Kp_vz_out_decay = 0.8
Vz_blend_ref (0 근처에서 estimator 덜 믿기)
Vz_blend_ref = 0.30 m/s
노이즈 심하면 0.4
추정 잘 나오면 0.2
failsafe slew/jerk (Vz_out에만)

초기 보수:
dVz_fail = 1.0 m/s²
d²Vz_fail = 4.0 m/s³
(너무 답답하면 1.5 / 6.0)

T_vz_fresh
T_vz_fresh = 0.10 s (100ms)
네트워크/ROS 브릿지로 지연 있으면 0.15s까지

6) Hardgate (안전 핵심, “학습 금지”)
초기 보수 가이드(손목 IMU 기준):
gyro_hi = 4.0 rad/s (≈ 230 deg/s)
acc_hi = 0.6 g (즉 ||acc||-1g ≥ 0.6g)
그리고 Hardgate는 50~100ms 디바운스(연속 조건) 걸어라
(한 샘플 튐으로 ENTRY 리셋되는 거 방지)

7) Hold
T_hold_L = 1.0 s
안전 이벤트 직후 1초는 “커밋 금지 + deadzone 축소 제한” 유지